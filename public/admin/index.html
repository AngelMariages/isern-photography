<!-- /public/admin/index.html -->
<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Content Manager</title>
	</head>
	<body>
		<script src="https://unpkg.com/netlify-cms@^2.0.0/dist/netlify-cms.js"></script>
		<script>
			async function getNaturalImageSize(url) {
				return new Promise((resolve) => {
					const img = new Image();
					img.src = url.replace(/^public(.*)/, "$1");
					img.onload = () => {
						resolve({
							width: img.naturalWidth,
							height: img.naturalHeight,
						});
					};
				});
			}

			async function preSaveHandler({ entry }) {
				const rawImage = entry.get("data").get("image");

				if (!rawImage) {
					return entry.get("data");
				}

				const image = rawImage.toJSON();
				const mediaFiles = entry.get("mediaFiles").toJSON();

				const mediaFile = mediaFiles.find(
					(mf) => mf.path.replace(/^public(.*)/, "$1") === image.src
				);

				let imageUrl = mediaFile.path;

				if (mediaFile.draft) {
					imageUrl = mediaFile.url;
				}

				const dimensions = await getNaturalImageSize(imageUrl);

				return entry
					.get("data")
					.set(
						"image",
						entry
							.get("data")
							.get("image")
							.set("width", dimensions.width)
							.set("height", dimensions.height)
					);
			}

			const OrderPreview = createClass({
				render: function () {
					const entry = this.props.entry;
					const data = entry.get("data").toJS();
					const imageOrder = data.imageOrder;

					return h(
						"div",
						{},
						h(
							"div",
							{
								style: {
									alignItems: "center",
									display: "flex",
									flexDirection: "column",
								},
							},
							imageOrder.map(({ imageName }, index) => {
								const url = this.props.getAsset(imageName);

								return h("div", {}, [
									h("p", {}, imageName),
									h("img", {
										src: url,
										key: index,
										style: {
											width: "70vh",
										},
									}),
								]);
							})
						)
					);
				},
			});

			window.addEventListener("load", function () {
				CMS.registerEventListener({
					name: "preSave",
					handler: preSaveHandler,
				});
				CMS.registerPreviewTemplate("imageOrder", OrderPreview);
			});
		</script>
	</body>
</html>
